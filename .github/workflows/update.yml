name: Aggiorna Sito CAI

on:
  schedule:
    - cron: '0 0,7,13,18 * * *'  # UTC - Gira alle 9:00, 15:00, 20:00 e 02:00 in ora solare
  workflow_dispatch: # Permette avvio manuale

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run aggregator
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python aggregator.py

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 1. Metti in coda (stage) tutti i file modificati
          git add *.html
          git add link_registry.json
          
          # 2. Fai il Commit (Salva localmente).
          # Il "|| echo..." serve a non far fallire lo script se non ci sono novit√†
          git commit -m "Aggiornamento eventi e registro" || echo "Nessuna modifica da committare"
          
          # 3. ORA puoi fare il pull (scaricare aggiornamenti remoti)
          # Usiamo --rebase per applicare le tue modifiche SOPRA quelle remote
          git pull --rebase origin main || git pull --rebase origin master
          
          # 4. Infine invia tutto
          git push   
